local Library = {}
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local MarketplaceService = game:GetService("MarketplaceService")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer
local Stats = game:GetService("Stats")

-- State & Configs
Library.Flags = {}
Library.Elements = {}
Library.Theme = {
    Main = Color3.fromRGB(10, 10, 12),
    Secondary = Color3.fromRGB(20, 20, 25),
    Stroke = Color3.fromRGB(30, 30, 35),
    Accent = Color3.fromRGB(0, 255, 255),
    Text = Color3.fromRGB(255, 255, 255),
    TextDark = Color3.fromRGB(150, 150, 150)
}
Library.Folder = "EzHub"

-- Icons (Updated with unique IDs)
local Lucide = {
    ["door-open"] = "rbxassetid://10747373176",
    ["settings"] = "rbxassetid://10734950309",
    ["user"] = "rbxassetid://10747383474",
    ["home"] = "rbxassetid://10747373176",
    ["search"] = "rbxassetid://10747314551",
    ["info"] = "rbxassetid://10747303383",
    ["x"] = "rbxassetid://10747384394",
    ["minus"] = "rbxassetid://10747384542",
    ["pc"] = "rbxassetid://10747374083",
    ["mobile"] = "rbxassetid://10747373856",
    ["tablet"] = "rbxassetid://10747373978",
}

local function GetIcon(iconName)
    if not iconName then return "" end
    if Lucide[iconName] then return Lucide[iconName] end
    if tostring(iconName):match("^rbxassetid://") then return iconName end
    return ""
end

-- Utility Functions
local function MakeDraggable(topbarobject, object)
    local Dragging, DragInput, DragStart, StartPosition

    local function Update(input)
        local Delta = input.Position - DragStart
        local pos = UDim2.new(StartPosition.X.Scale, StartPosition.X.Offset + Delta.X, StartPosition.Y.Scale, StartPosition.Y.Offset + Delta.Y)
        TweenService:Create(object, TweenInfo.new(0.15, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Position = pos}):Play()
    end

    topbarobject.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            Dragging = true
            DragStart = input.Position
            StartPosition = object.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    Dragging = false
                end
            end)
        end
    end)

    topbarobject.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            DragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == DragInput and Dragging then
            Update(input)
        end
    end)
end

local function CreateStarfield(parent)
    local rng = Random.new()
    local StarContainer = Instance.new("Frame")
    StarContainer.Name = "StarContainer"
    StarContainer.Size = UDim2.new(1, 0, 1, 0)
    StarContainer.BackgroundTransparency = 1
    StarContainer.Parent = parent
    StarContainer.ZIndex = 1

    for i = 1, 50 do
        local Star = Instance.new("Frame")
        Star.Name = "Star"
        Star.Size = UDim2.new(0, rng:NextInteger(1, 3), 0, rng:NextInteger(1, 3))
        Star.Position = UDim2.new(rng:NextNumber(), 0, rng:NextNumber(), 0)
        Star.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        Star.BackgroundTransparency = rng:NextNumber(0.3, 0.8)
        Star.Parent = StarContainer
        
        task.spawn(function()
            while Star and Star.Parent do
                local t = rng:NextNumber(2, 5)
                TweenService:Create(Star, TweenInfo.new(t), {BackgroundTransparency = 1}):Play()
                task.wait(t)
                if not Star or not Star.Parent then break end
                TweenService:Create(Star, TweenInfo.new(t), {BackgroundTransparency = rng:NextNumber(0.3, 0.8)}):Play()
                task.wait(t)
            end
        end)
    end
end

-- Notification System
local NotificationContainer = nil
function Library:Notify(Config)
    local Title = Config.Title or "Notification"
    local Content = Config.Content or ""
    local Duration = Config.Duration or 3

    if not NotificationContainer then
        local ScreenGui = Instance.new("ScreenGui")
        ScreenGui.Name = "EzHub_Notifications"
        pcall(function() ScreenGui.Parent = game.CoreGui end)
        if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui") end
        
        NotificationContainer = Instance.new("Frame")
        NotificationContainer.Name = "Container"
        NotificationContainer.Parent = ScreenGui
        NotificationContainer.BackgroundTransparency = 1
        NotificationContainer.Position = UDim2.new(1, -320, 1, -20)
        NotificationContainer.Size = UDim2.new(0, 300, 1, 0)
        NotificationContainer.AnchorPoint = Vector2.new(0, 1)
        
        local Layout = Instance.new("UIListLayout")
        Layout.Parent = NotificationContainer
        Layout.SortOrder = Enum.SortOrder.LayoutOrder
        Layout.VerticalAlignment = Enum.VerticalAlignment.Bottom
        Layout.Padding = UDim.new(0, 10)
    end

    local NotifyFrame = Instance.new("Frame")
    NotifyFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    NotifyFrame.Size = UDim2.new(1, 0, 0, 0)
    NotifyFrame.ClipsDescendants = true
    NotifyFrame.Parent = NotificationContainer
    
    Instance.new("UIStroke", NotifyFrame).Color = Library.Theme.Accent
    Instance.new("UICorner", NotifyFrame).CornerRadius = UDim.new(0, 8)
    
    local TitleLabel = Instance.new("TextLabel")
    TitleLabel.Parent = NotifyFrame
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Position = UDim2.new(0, 15, 0, 10)
    TitleLabel.Size = UDim2.new(1, -20, 0, 20)
    TitleLabel.Font = Enum.Font.GothamBold
    TitleLabel.Text = Title
    TitleLabel.TextColor3 = Library.Theme.Text
    TitleLabel.TextSize = 15
    TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    local ContentLabel = Instance.new("TextLabel")
    ContentLabel.Parent = NotifyFrame
    ContentLabel.BackgroundTransparency = 1
    ContentLabel.Position = UDim2.new(0, 15, 0, 30)
    ContentLabel.Size = UDim2.new(1, -20, 0, 40)
    ContentLabel.Font = Enum.Font.Gotham
    ContentLabel.Text = Content
    ContentLabel.TextColor3 = Library.Theme.TextDark
    ContentLabel.TextSize = 13
    ContentLabel.TextWrapped = true
    ContentLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    local ProgressBar = Instance.new("Frame")
    ProgressBar.Parent = NotifyFrame
    ProgressBar.BackgroundColor3 = Library.Theme.Accent
    ProgressBar.Position = UDim2.new(0, 0, 1, -2)
    ProgressBar.Size = UDim2.new(1, 0, 0, 2)
    
    TweenService:Create(NotifyFrame, TweenInfo.new(0.5, Enum.EasingStyle.Quart), {Size = UDim2.new(1, 0, 0, 80)}):Play()
    TweenService:Create(ProgressBar, TweenInfo.new(Duration, Enum.EasingStyle.Linear), {Size = UDim2.new(0, 0, 0, 2)}):Play()
    
    task.delay(Duration, function()
        TweenService:Create(NotifyFrame, TweenInfo.new(0.5, Enum.EasingStyle.Quart), {Size = UDim2.new(1, 0, 0, 0)}):Play()
        task.wait(0.5)
        NotifyFrame:Destroy()
    end)
end

function Library:CreateWindow(Config)
    local Title = Config.Title or "EzHub"
    local BaseSize = Config.Size or UDim2.fromOffset(500, 400) 
    local ToggleKey = Config.ToggleKey or Enum.KeyCode.RightControl
    local CustomGameName = Config.GameName or "EzHub Game"
    
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "EzHub_UI"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.IgnoreGuiInset = true
    pcall(function() ScreenGui.Parent = game.CoreGui end)
    if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui") end

    local Window = {PendingTabs = {}, PendingLists = {}, ScaleFactor = 1}
    local MainContainer, LeftWindow, RightWindow, Built = nil, nil, nil, false

    -- Background Overlay
    local BackgroundOverlay = Instance.new("Frame")
    BackgroundOverlay.Parent = ScreenGui
    BackgroundOverlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    BackgroundOverlay.Size = UDim2.new(1, 0, 1, 0)
    BackgroundOverlay.Visible = false
    BackgroundOverlay.BackgroundTransparency = 1
    CreateStarfield(BackgroundOverlay)

    -- Device Selector
    local DeviceModal = Instance.new("Frame")
    DeviceModal.Parent = ScreenGui
    DeviceModal.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    DeviceModal.Size = UDim2.new(1, 0, 1, 0)
    DeviceModal.ZIndex = 100

    local ButtonContainer = Instance.new("Frame")
    ButtonContainer.Parent = DeviceModal
    ButtonContainer.BackgroundTransparency = 1
    ButtonContainer.Size = UDim2.new(0, 600, 0, 150)
    ButtonContainer.Position = UDim2.new(0.5, -300, 0.5, -75)
    local Layout = Instance.new("UIListLayout")
    Layout.Parent = ButtonContainer
    Layout.FillDirection = Enum.FillDirection.Horizontal
    Layout.Padding = UDim.new(0, 20)
    Layout.HorizontalAlignment = Enum.HorizontalAlignment.Center

    local function BuildMainUI(scale)
        if Built then return end
        Built = true
        Window.ScaleFactor = scale
        local Size = UDim2.fromOffset(BaseSize.X.Offset * scale, BaseSize.Y.Offset * scale)
        
        TweenService:Create(DeviceModal, TweenInfo.new(0.5), {BackgroundTransparency = 1}):Play()
        task.delay(0.5, function() DeviceModal:Destroy() end)

        local function CreateStyledWindow(name, size, position)
            local Frame = Instance.new("Frame")
            Frame.Name = name
            Frame.Parent = ScreenGui
            Frame.Size = size
            Frame.Position = position
            Frame.BackgroundColor3 = Library.Theme.Main
            Frame.BorderSizePixel = 0
            Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 12)
            local Stroke = Instance.new("UIStroke", Frame)
            Stroke.Color = Library.Theme.Stroke
            Stroke.Thickness = 1
            return Frame
        end

        MainContainer = CreateStyledWindow("MainContainer", Size, UDim2.new(0.5, -Size.X.Offset/2, 0.5, -Size.Y.Offset/2))
        MakeDraggable(MainContainer, MainContainer)

        -- Header
        local TitleLabel = Instance.new("TextLabel")
        TitleLabel.Parent = MainContainer
        TitleLabel.BackgroundTransparency = 1
        TitleLabel.Position = UDim2.new(0, 20, 0, 15)
        TitleLabel.Size = UDim2.new(0, 200, 0, 25)
        TitleLabel.Font = Enum.Font.GothamBold
        TitleLabel.Text = CustomGameName
        TitleLabel.TextColor3 = Library.Theme.Text
        TitleLabel.TextSize = 16 * scale
        TitleLabel.TextXAlignment = Enum.TextXAlignment.Left

        -- Sidebar
        local TabBar = Instance.new("ScrollingFrame")
        TabBar.Parent = MainContainer
        TabBar.BackgroundTransparency = 1
        TabBar.Position = UDim2.new(0, 10, 0, 60)
        TabBar.Size = UDim2.new(0, 120 * scale, 1, -70)
        TabBar.ScrollBarThickness = 0
        local TabList = Instance.new("UIListLayout", TabBar)
        TabList.Padding = UDim.new(0, 5)

        local PagesContainer = Instance.new("Frame")
        PagesContainer.Parent = MainContainer
        PagesContainer.BackgroundTransparency = 1
        PagesContainer.Position = UDim2.new(0, 140 * scale, 0, 60)
        PagesContainer.Size = UDim2.new(1, -150 * scale, 1, -70)
        
        Window.PagesContainer = PagesContainer
        Window.TabBar = TabBar

        -- Execute Pending Tabs
        for _, initFunc in ipairs(Window.PendingTabs) do initFunc() end
        for _, initFunc in ipairs(Window.PendingLists) do initFunc() end
    end

    local function CreateDeviceButton(name, icon, scale)
        local Btn = Instance.new("Frame")
        Btn.Size = UDim2.new(0, 150, 0, 150)
        Btn.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
        Btn.Parent = ButtonContainer
        Instance.new("UICorner", Btn).CornerRadius = UDim.new(0, 12)
        local Stroke = Instance.new("UIStroke", Btn)
        Stroke.Color = Library.Theme.Accent
        Stroke.Transparency = 0.5

        local Trigger = Instance.new("TextButton")
        Trigger.Size = UDim2.new(1, 0, 1, 0)
        Trigger.BackgroundTransparency = 1
        Trigger.Text = name
        Trigger.Font = Enum.Font.GothamBold
        Trigger.TextColor3 = Color3.fromRGB(255, 255, 255)
        Trigger.TextSize = 18
        Trigger.Parent = Btn

        Trigger.MouseButton1Click:Connect(function() BuildMainUI(scale) end)
        Trigger.MouseEnter:Connect(function() 
            TweenService:Create(Btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(40, 40, 45)}):Play() 
            TweenService:Create(Stroke, TweenInfo.new(0.2), {Transparency = 0}):Play()
        end)
        Trigger.MouseLeave:Connect(function() 
            TweenService:Create(Btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(30, 30, 35)}):Play() 
            TweenService:Create(Stroke, TweenInfo.new(0.2), {Transparency = 0.5}):Play()
        end)
    end

    CreateDeviceButton("PC", "pc", 1)
    CreateDeviceButton("MOBILE", "mobile", 0.7)

    function Window:Tab(TabConfig)
        local TabObj = {Elements = {}}
        
        local function Init()
            local TabBtn = Instance.new("TextButton")
            TabBtn.Parent = Window.TabBar
            TabBtn.Size = UDim2.new(1, 0, 0, 35)
            TabBtn.BackgroundColor3 = Library.Theme.Secondary
            TabBtn.Text = TabConfig.Title
            TabBtn.Font = Enum.Font.GothamMedium
            TabBtn.TextColor3 = Library.Theme.TextDark
            TabBtn.TextSize = 12 * Window.ScaleFactor
            Instance.new("UICorner", TabBtn).CornerRadius = UDim.new(0, 6)

            local Page = Instance.new("ScrollingFrame")
            Page.Parent = Window.PagesContainer
            Page.Size = UDim2.new(1, 0, 1, 0)
            Page.BackgroundTransparency = 1
            Page.Visible = false
            Page.ScrollBarThickness = 2
            local PageLayout = Instance.new("UIListLayout", Page)
            PageLayout.Padding = UDim.new(0, 8)

            TabBtn.MouseButton1Click:Connect(function()
                for _, p in pairs(Window.PagesContainer:GetChildren()) do p.Visible = false end
                for _, b in pairs(Window.TabBar:GetChildren()) do
                    if b:IsA("TextButton") then
                        TweenService:Create(b, TweenInfo.new(0.2), {BackgroundColor3 = Library.Theme.Secondary, TextColor3 = Library.Theme.TextDark}):Play()
                    end
                end
                Page.Visible = true
                TweenService:Create(TabBtn, TweenInfo.new(0.2), {BackgroundColor3 = Library.Theme.Accent, TextColor3 = Color3.fromRGB(0, 0, 0)}):Play()
            end)

            function TabObj:Button(Config)
                local Btn = Instance.new("TextButton")
                Btn.Parent = Page
                Btn.Size = UDim2.new(1, -10, 0, 40)
                Btn.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
                Btn.Text = Config.Title
                Btn.Font = Enum.Font.GothamBold
                Btn.TextColor3 = Library.Theme.Text
                Btn.TextSize = 14 * Window.ScaleFactor
                Instance.new("UICorner", Btn).CornerRadius = UDim.new(0, 6)
                local S = Instance.new("UIStroke", Btn)
                S.Color = Library.Theme.Stroke

                Btn.MouseButton1Click:Connect(Config.Callback)
                Btn.MouseEnter:Connect(function() TweenService:Create(S, TweenInfo.new(0.2), {Color = Library.Theme.Accent}):Play() end)
                Btn.MouseLeave:Connect(function() TweenService:Create(S, TweenInfo.new(0.2), {Color = Library.Theme.Stroke}):Play() end)
            end

            function TabObj:Toggle(Config)
                local Toggled = Config.Default or false
                local TFrame = Instance.new("Frame")
                TFrame.Parent = Page
                TFrame.Size = UDim2.new(1, -10, 0, 40)
                TFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
                Instance.new("UICorner", TFrame).CornerRadius = UDim.new(0, 6)

                local Lab = Instance.new("TextLabel", TFrame)
                Lab.Text = Config.Title
                Lab.Position = UDim2.new(0, 15, 0, 0)
                Lab.Size = UDim2.new(1, -60, 1, 0)
                Lab.BackgroundTransparency = 1
                Lab.Font = Enum.Font.Gotham
                Lab.TextColor3 = Library.Theme.Text
                Lab.TextXAlignment = "Left"

                local Box = Instance.new("Frame", TFrame)
                Box.Size = UDim2.new(0, 34, 0, 18)
                Box.Position = UDim2.new(1, -45, 0.5, -9)
                Box.BackgroundColor3 = Toggled and Library.Theme.Accent or Color3.fromRGB(50, 50, 50)
                Instance.new("UICorner", Box).CornerRadius = UDim.new(1, 0)

                local Dot = Instance.new("Frame", Box)
                Dot.Size = UDim2.new(0, 14, 0, 14)
                Dot.Position = Toggled and UDim2.new(1, -16, 0.5, -7) or UDim2.new(0, 2, 0.5, -7)
                Dot.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
                Instance.new("UICorner", Dot).CornerRadius = UDim.new(1, 0)

                local Trig = Instance.new("TextButton", TFrame)
                Trig.Size = UDim2.new(1, 0, 1, 0)
                Trig.BackgroundTransparency = 1
                Trig.Text = ""

                Trig.MouseButton1Click:Connect(function()
                    Toggled = not Toggled
                    TweenService:Create(Box, TweenInfo.new(0.2), {BackgroundColor3 = Toggled and Library.Theme.Accent or Color3.fromRGB(50, 50, 50)}):Play()
                    TweenService:Create(Dot, TweenInfo.new(0.2), {Position = Toggled and UDim2.new(1, -16, 0.5, -7) or UDim2.new(0, 2, 0.5, -7)}):Play()
                    Config.Callback(Toggled)
                end)
            end
        end

        if Built then Init() else table.insert(Window.PendingTabs, Init) end
        return TabObj
    end

    return Window
end

return Library
